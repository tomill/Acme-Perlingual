<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <title>Acme::P2P test</title>
    
    <link rel="stylesheet" href="//static.koneta.org/base.css" type="text/css" />    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>

<style type="text/css" media="screen">
.container {
    width: 1300px;
    min-height: 450px;
}
.input, .output {
    float: left;
    width: 600px;
}
.input {
    margin-right: 20px;    
}
.box {
    white-space: pre-wrap;
}
.editor { 
    font-size: 20px;
    height: 300px;
    border: 1px solid silver;
    margin: 0 0 20px;
}

.output .ace_marker-layer,
.output .ace_cursor-layer {
    display: none;
}
</style>

<script type="text/javascript">
function p2p() {
    var input = ace.edit('input').getValue();
    if (!input) return;

    $('.input .box, .output .box').hide();
    $('.input .information').text('...').show();

    $.ajax({
        type: 'POST',
        url: '/api',
        data: { input: input },
        dataType: 'json'
    }).done(function(data){
        $('.input .box, .output .box').hide();
        
        if (data.error) {
            $('.output .error').text(data.error).show();
        } else {
            $('.output .success').text('fine. no error found :)').show();
        }
        
        ace.edit('output').setValue(data.output, 1);
    }).fail(function(e, txt){
        console.log(e);
        $('.input .box, .output .box').hide();
        $('.input .error').text([ txt, '-', e.status, e.statusText ].join(' ')).show();
    });
}

jQuery(function($){
    var ace_options = {
        theme: 'ace/theme/xcode',
        highlightActiveLine: false,
        showGutter: false,
        displayIndentGuides: false
    };
    
    var input = ace.edit('input');
    input.setOptions(ace_options);
    input.getSession().setMode('ace/mode/perl');
    input.getSession().on('change', p2p);

    var output = ace.edit('output');
    output.setOptions(ace_options);
    output.setReadOnly(true);
    output.getSession().setMode('ace/mode/php');
});
</script>

</head>
<body>
<div class="container clear">
    <h1>Acme::P2P test</h1>

    <div class="input">
        <h5>perl</h5>
        <div class="editor" id="input">#!perl
if ($foo) {
    print "foo";
}
</div>
        <p class="information box hidden"></p>
        <p class="error box hidden"></p>
    </div>

    <div class="output">
        <h5>php</h5>
        <div class="editor" id="output">&lt;?php
if ($foo) {
    print("foo");
}
</div>
        <p class="success box hidden"></p>
        <p class="error box hidden"></p>
    </div>

</div>

<div class="footer clear grays">
    &copy; <a href="http://twitter.com/tomita">tomita</a> 
</div>

</body>
</html>
